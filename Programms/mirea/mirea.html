
<!DOCTYPE html>
<!--
/*
 * Copyright (C) 2009 Apple Inc. All Rights Reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS'' AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
 -->
<html>
  <head>
    <title>MIREA</title>
    <script type="text/javascript" src="./webgl-utils.js"></script>
    <script type="text/javascript" src="./webgl-debug.js"></script>
    <script type="text/javascript" src="./J3DI.js"> </script>
    <script type="text/javascript" src="./J3DIMath.js"> </script>
    <script type="text/javascript" src="./Controls.js"> </script>

    <script id="vshader" type="x-shader/x-vertex">
        uniform mat4 u_modelViewProjMatrix;
        uniform mat4 u_normalMatrix;
        uniform vec3 lightDir;

        attribute vec3 vNormal;
        attribute vec4 vTexCoord;
        attribute vec4 vPosition;

        varying float v_Dot;
        varying vec2 v_texCoord;

        void main()
        {
            gl_Position = u_modelViewProjMatrix * vPosition;
            v_texCoord = vTexCoord.st;
            vec4 transNormal = u_normalMatrix * vec4(vNormal,1);
            v_Dot = max(dot(transNormal.xyz, lightDir), 0.4);
        }
    </script>
    
    <script id="fshader" type="x-shader/x-fragment">
        precision mediump float;

        uniform sampler2D sampler2d;

        varying float v_Dot;
        varying vec2 v_texCoord;

        void main()
        {
            vec4 color = texture2D(sampler2d,v_texCoord);
            color += vec4(0.1,0.1,0.1,1);
            gl_FragColor = vec4(color.xyz * v_Dot, color.a);
        }
    </script>
   
    <script>
        const numRowCols = 4;
        const numLayers = 1;
        const layoutWidth = 0;
        const layoutHeight = 1.4;
        const globeSize = 25;
        const minIncAngle = 0.2;
        const maxIncAngle = 2;
        var g = {};  // globals
        
        function init()
        {
            var gl = initWebGL("example");
            if (!gl) {
                return;
            }
            g.program = simpleSetup(gl, "vshader", "fshader",
            //g.program = simpleSetup(gl, "shader-vs", "shader-fs",
                                [ "vPosition", "vTexCoord", "vNormal"],
                                [ 0, 0.5, 0.5, 1 ], 10000);
            gl.uniform3f(gl.getUniformLocation(g.program, "lightDir"), 0.5, 1, 0);
            gl.uniform1i(gl.getUniformLocation(g.program, "sampler2d"), 0);
        

            if (g.program) {
                g.u_normalMatrixLoc = gl.getUniformLocation(g.program, "u_normalMatrix");
                g.u_modelViewProjMatrixLoc = gl.getUniformLocation(g.program, "u_modelViewProjMatrix");
            }

            g.buildings = loadObj(gl, "./mirea.obj");
            g.buildings.parsed = false;

            // get the images
            g.Textures = [];
            g.Textures['stair'] = loadImageTexture(gl, "./Stone.1.jpg");
            g.Textures['building'] = loadImageTexture(gl, "./Brick_Non_Uniform_Running_Red.jpg");
            g.Textures['door'] = loadImageTexture(gl, "./Water_2.jpg");
            g.Textures['wall']  = loadImageTexture(gl, "./Brick_Non_Uniform_Running_Red.jpg");
            g.Textures['floor'] = loadImageTexture(gl, "./Finishes.Flooring.Wood.Parquet.12.jpg");
            g.Textures['roof'] = loadImageTexture(gl, "./Finishes.Flooring.Wood.Parquet.12.jpg");

            return gl;
        }

        width = -1;
        height = -1;
        g.Step = 0;
        g.open = true;
        g.close = false;
        var requestId;

        function reshape(ctx)
        {
            var canvas = document.getElementById('example');
            if (canvas.width == width && canvas.height == height)
                return;

            g.width = canvas.width;
            g.height = canvas.height;

            ctx.viewport(0, 0, g.width , g.height);

            //g.perspectiveMatrix = new J3DIMatrix4();
            //g.perspectiveMatrix.perspective(30, g.width /height, 1, 10000);
            //g.perspectiveMatrix.lookat(0,0,20, 0, 0, 0, 0, 1, 0);
            //g.perspectiveMatrix.rotate(40, 1,0,0);
            //g.perspectiveMatrix.rotate(yRot/5, 0,1,0);
        }

        function drawOne(ctx, angle, x, y, z, scale, texture, obj)
        {   
            if(!g.buildings.loaded){
                return;
            }
            if(!g.buildings.parsed){
                return;
            }
            if (typeof(obj) == 'undefined'){
                return;
            }
            //if(typeof(g.buildings.groups[objName]) == "undefined"){
            //    return;
            //}
            
            // setup VBOs
            ctx.enableVertexAttribArray(0);
            ctx.enableVertexAttribArray(1);
            ctx.enableVertexAttribArray(2);

            ctx.bindBuffer(ctx.ARRAY_BUFFER, g.buildings.vertexObject);
            ctx.vertexAttribPointer(0, 3, ctx.FLOAT, false, 0, 0);

            ctx.bindBuffer(ctx.ARRAY_BUFFER, g.buildings.normalObject);
            ctx.vertexAttribPointer(2, 3, ctx.FLOAT, false, 0, 0);

            ctx.bindBuffer(ctx.ARRAY_BUFFER, g.buildings.texCoordObject);
            ctx.vertexAttribPointer(1, 2, ctx.FLOAT, false, 0, 0);

            ctx.bindBuffer(ctx.ELEMENT_ARRAY_BUFFER, g.buildings.indexObject);

            // generate the model-view matrix
            var mvMatrix = new J3DIMatrix4();

            mvMatrix.translate(x,y,z);
            //mvMatrix.translate(5, -3, 0);
            //mvMatrix.rotate(30, 1,0,0);
            //mvMatrix.rotate(yRot/5, 0,1,0);
            //mvMatrix.rotate(angle, 1,0,0);
            mvMatrix.scale(scale, scale, scale);
            
            // construct the normal matrix from the model-view matrix
            var normalMatrix = new J3DIMatrix4(mvMatrix);
            normalMatrix.invert();
            normalMatrix.transpose();
            normalMatrix.setUniform(ctx, g.u_normalMatrixLoc, false);

            // construct the model-view * projection matrix
            var mvpMatrix = new J3DIMatrix4(g.perspectiveMatrix);
            mvpMatrix.multiply(mvMatrix);
            mvpMatrix.setUniform(ctx, g.u_modelViewProjMatrixLoc, false);
            

            ctx.bindTexture(ctx.TEXTURE_2D, texture);
            var count = obj.obj.count;
            var indicies = obj.obj.index;
            ctx.drawElements(ctx.TRIANGLES, count, ctx.UNSIGNED_SHORT, indicies * 2);
            //ctx.drawElements(ctx.TRIANGLES, g.buildings.numIndices, ctx.UNSIGNED_SHORT, 0);
            //ctx.drawElements(ctx.TRIANGLES, 3870, ctx.UNSIGNED_SHORT, 0);
        }

        function drawPicture(ctx)
        {
            reshape(ctx);
	        ctx.clear(ctx.COLOR_BUFFER_BIT | ctx.DEPTH_BUFFER_BIT);
            
            var mvMatrix = new J3DIMatrix4();
            g.perspectiveMatrix = new J3DIMatrix4();
            g.perspectiveMatrix.perspective(50, g.width /g.height, 1, 10000);
            g.perspectiveMatrix.translate( 0, 0, transl * 5);
            g.perspectiveMatrix.lookat(0,0,20, 0, 0, 0, 0, 1, 0);            
            g.perspectiveMatrix.rotate(zRot, 0,0,1);
            g.perspectiveMatrix.rotate(xRot/5 + 60, 1,0,0);
            g.perspectiveMatrix.rotate(yRot/5, 0,1,0);
            
            if(!g.buildings.loaded){
                return;
            }
            if(!g.buildings.parsed){
                // G_building
                // G_1_floor
                // G_1_floor_1
                var RE_4 = /(\w+)_(\d+)_(\w+)_(\d+)$/; // элемент
                var RE_2 = /(\w+)_(\d+)_floor$/; // этаж
                var RE_1 = /(\w+)_building$/; // здание
                g.buildings.parsed = true;
                g.buildings.items = [];
                /*
                    g.buildings.items = [
                        G:{ 
                            Name:name,
                            Selected : false,
                            items : [
                                floor:{
                                    Name:name,
                                    Selected : false
                                    items : [
                                        wall:{
                                            Name:name,
                                            Selected : false                                    
                                        },
                                        stair:{
                                            Name:name,
                                            Selected : false                                    
                                        },
                                        door:{
                                            Name:name,
                                            Selected : false,
                                            box:{
                                                Xmin:0,Ymin:0,Zmin:0,
                                                Xmax:0,Ymax:0,Zmax:0,
                                                first:true,
                                            };
                                            obj:{index:0,count:0};
                                        },
                                    ],
                                },
                            ]
                        },
                        A:{
                        }
                    ];
                */
                for (var objName in g.buildings.groups) {
                    var T = RE_4.exec(objName);
                    var B = RE_1.exec(objName);
                    var L = RE_2.exec(objName);

                    if(B){ 
                        var b = B[1];
                        if (typeof(g.buildings.items[b]) == 'undefined'){ // здание
                            g.buildings.items[b] = {};
                            g.buildings.items[b].items = [];
                        } 
                        g.buildings.items[b].Name = objName;
                        g.buildings.items[b].Selected = false;
                        g.buildings.items[b].TextureName = "building";
                        g.buildings.items[b].box = g.buildings.groups[objName].box;
                        g.buildings.items[b].obj = {};
                        g.buildings.items[b].obj.index = g.buildings.groups[objName].index;
                        g.buildings.items[b].obj.count = g.buildings.groups[objName].count;
                    } else if(L){ 
                        var b = L[1];
                        var f = L[2];
                        if (typeof(g.buildings.items[b]) == 'undefined'){ // здание
                            g.buildings.items[b] = {}; 
                            g.buildings.items[b].items = [];
                        } 
                        if (typeof(g.buildings.items[b].items[f]) == 'undefined'){ // этаж
                            g.buildings.items[b].items[f] = {};                            
                            g.buildings.items[b].items[f].items = [];
                        }
                        g.buildings.items[b].items[f].Name = objName;
                        g.buildings.items[b].items[f].Selected = false;
                        g.buildings.items[b].items[f].TextureName = "building";
                        g.buildings.items[b].items[f].box = g.buildings.groups[objName].box;
                        g.buildings.items[b].items[f].obj = {};
                        g.buildings.items[b].items[f].obj.index = g.buildings.groups[objName].index;
                        g.buildings.items[b].items[f].obj.count = g.buildings.groups[objName].count;
                        
                    } else if(T){ //G_1_stair_1
                        var b = T[1];
                        var f = T[2];
                        var o = T[3];
                        var n = T[4];
                        // g.buildings.items['G']
                        if (typeof(g.buildings.items[b]) == 'undefined'){ // здание G
                            g.buildings.items[b] = {}; 
                            g.buildings.items[b].items = [];
                        } 
                        //g.buildings.items['G'].items[1]
                        if (typeof(g.buildings.items[b].items[f]) == 'undefined'){ // этаж 1
                            g.buildings.items[b].items[f] = {};
                            g.buildings.items[b].items[f].items = [];
                        }
                        //g.buildings.items['G'].items[1].items['stair']
                        if (typeof(g.buildings.items[b].items[f].items[o]) == 'undefined'){ // элемент на этаже (stair)
                            g.buildings.items[b].items[f].items[o] = {};
                            g.buildings.items[b].items[f].items[o].items = [];
                        } 
                        g.buildings.items[b].items[f].items[o].Selected = true;
                        
                        //g.buildings.items['G'].items[1].items['stair'].items[0]
                        var i = g.buildings.items[b].items[f].items[o].items.length;
                        g.buildings.items[b].items[f].items[o].items[i] = {};
                        g.buildings.items[b].items[f].items[o].items[i].Name = objName;
                        g.buildings.items[b].items[f].items[o].items[i].Selected = false;
                        g.buildings.items[b].items[f].items[o].items[i].box = g.buildings.groups[objName].box;
                        g.buildings.items[b].items[f].items[o].items[i].obj = {};
                        g.buildings.items[b].items[f].items[o].items[i].obj.index = g.buildings.groups[objName].index;
                        g.buildings.items[b].items[f].items[o].items[i].obj.count = g.buildings.groups[objName].count;

                        if(o == "stair"){
                            g.buildings.items[b].items[f].items[o].items[i].TextureName = "stair";
                        } else if(o == "wall"){
                            g.buildings.items[b].items[f].items[o].items[i].TextureName = "wall"; 
                        } else if(o == "floor"){
                            g.buildings.items[b].items[f].items[o].items[i].TextureName = "floor";
                        } else if(o == "door"){
                            g.buildings.items[b].items[f].items[o].items[i].TextureName = "door";
                        }
                    } else {
                        objName = "";
                    }
                }                
            }
            
            var X = 0;
            var Y = 0;
            var Z = 0;
            var b = document.getElementById("building_id").value;
            for (var i in g.buildings.items) {
                g.buildings.items[i].Selected = false;
            }
            if(typeof(g.buildings.items[b]) != 'undefined'){
                g.buildings.items[b].Selected = true;
                X = -(g.buildings.items[b].box.Xmin + (g.buildings.items[b].box.Xmax - g.buildings.items[b].box.Xmin)/2);
                Y = -(g.buildings.items[b].box.Ymin + (g.buildings.items[b].box.Ymax - g.buildings.items[b].box.Ymin)/2);
                Z = -(g.buildings.items[b].box.Zmin + (g.buildings.items[b].box.Zmax - g.buildings.items[b].box.Zmin)/2);
            }
            if(b == 'G'){
                var f = document.getElementById("level_id").value;
                g.buildings.items.G.items[f].Selected = true;
            }
            //for(i = 0; i < g.buildings.groups.length; i++){
            doDrawItem(ctx, g.buildings.items, X, Y, Z);

            ctx.bindTexture(ctx.TEXTURE_2D, null);

            framerate.snapshot();
        }
        function doDrawItem(ctx, items, X,Y,Z){
            for (var i in items) {
                if(!items[i].Selected){
                    //(ctx, angle, x, y, z, scale, texture, objName)
                    drawOne(ctx, 0, X, Y, Z,  1, g.Textures[items[i].TextureName], items[i]);
                } else {
                    doDrawItem(ctx, items[i].items, X,Y,Z);
                }
            }
        }
        function start()
        {
            var c = document.getElementById("example");
            var w = Math.floor(window.innerWidth * 0.9);
            var h = Math.floor(window.innerHeight * 0.9);

            //c = WebGLDebugUtils.makeLostContextSimulatingCanvas(c);
            // tell the simulator when to lose context.
            //c.loseContextInNCalls(1500);

            c.addEventListener('webglcontextlost', handleContextLost, false);
            c.addEventListener('webglcontextrestored', handleContextRestored, false);

            c.width = w;
            c.height = h;

            var ctx = init();
            if (!ctx) {
                return;
            }
            initControl(c);
            currentAngles = [ ];
            incAngles = [ ];
            showEarth = [ ];

            for (var i = 0; i < numRowCols * numRowCols * numLayers; ++i) {
                currentAngles[i] = 0;
                incAngles[i] = Math.random() * (maxIncAngle - minIncAngle) + minIncAngle;
                showEarth[i] = Math.random() > 0.5;
            }

            framerate = new Framerate("framerate");
            var f = function() {
                drawPicture(ctx)
                requestId = window.requestAnimFrame(f, c);
            };
            f();

            function handleContextLost(e) {
                e.preventDefault();
                clearLoadingImages();
                if (requestId !== undefined) {
                    window.cancelAnimFrame(requestId);
                    requestId = undefined;
                }
            }

            function handleContextRestored() {
                init();
                f();
            }
        }
    </script>
    <style type="text/css">
        canvas {
            border: 2px solid black;
        }
    </style>
  </head>
  <body onload="start()">
    <canvas id="example">
    There is supposed to be an example drawing here, but it's not important.
    </canvas>
    <div id="framerate"></div>
    <div> 
        <select id="building_id">
            <option value="10" selected>Общий вид</option>
            <option value="A0">Корпус А вход</option>
            <option value="A1">Корпус А левое крыло</option>
            <option value="A2">Корпус А правое крыло</option>
            <option value="B">Корпус Б</option>
            <option value="V">Корпус В</option>
            <option value="G">Корпус Г</option>
            <option value="D"> Корпус Д</option>
        </select>
        <select id="level_id">
            <option value="10">Выберите этаж</option>
            <option value="1">Этаж 1</option>
            <option value="2">Этаж 2</option>
            <option value="3">Этаж 3</option>
            <option value="4">Этаж 4</option>
            <option value="5" selected>Этаж 5</option>
        </select>
    </div>
  </body>
</html>
